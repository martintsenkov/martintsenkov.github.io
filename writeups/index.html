<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Writeups — Martin Tsenkov</title>
  <style>
    /* Base layout (Obsidian-like) */
    body{font-family:Inter,Arial;background:#1e1e22;color:#e6eef6;margin:0;display:flex;height:100vh}ано
    #sidebar{width:320px;border-right:1px solid #2d2d31;padding:12px;overflow:auto;background:#252529}
    #main{flex:1;display:flex;flex-direction:column;background:#1f1f23}
    #viewer{padding:20px;overflow:auto;height:calc(100vh - 260px);background:#1a1a1e}
    #graph{height:260px;border-top:1px solid #2d2d31}
    a{color:#7fd1ff;text-decoration:none}
    input{width:100%;padding:8px;margin-bottom:10px;border-radius:4px;border:1px solid #34363a;background:#1b1d21;color:#ddd}
    ul{list-style:none;padding:0;margin:0}
    li{padding:6px 0;border-bottom:1px dashed #2a2a2e}
    header{padding:12px;border-bottom:1px solid #2d2d31;background:#2a2a2e}
    .meta{font-size:13px;color:#9aa6b2}

    /* Mobile tweak: stack sidebar on top */
    @media (max-width: 720px){
      body{flex-direction:column}
      #sidebar{width:auto;border-right:none;border-bottom:1px solid #2d2d31}
      #viewer{height:auto;min-height:42vh}
      #graph{height:42vh}
    }
  </style>
</head>
<body>
  <aside id="sidebar">
    <header>
      <strong>CTF &amp; Lab Writeups</strong>
      <div class="meta"> Martin's offensive security whiteups</div>
    </header>
    <input id="search" placeholder="Search title or tag…">
    <ul id="list"></ul>
  </aside>

  <section id="main">
    <div id="viewer"><div style="padding:24px;color:#9aa6b2">Select a writeup from the list on the left.</div></div>
    <div id="graph"></div>
  </section>

  <script src="https://unpkg.com/markdown-it/dist/markdown-it.min.js"></script>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>

  <script>
  const md = window.markdownit();
  const manifestUrl = '/writeups/manifest.json';
  const listEl = document.getElementById('list');
  const viewer = document.getElementById('viewer');
  const search = document.getElementById('search');
  let manifest = [], cy;

  async function loadManifest(){
    try{
      const r = await fetch(manifestUrl);
      if(!r.ok) throw new Error('manifest not found');
      manifest = await r.json();

      if(!Array.isArray(manifest) || manifest.length === 0){
        listEl.innerHTML = '<li style="color:#9aa6b2">No notes yet. Add entries to <code>writeups/manifest.json</code>.</li>';
      } else {
        renderList(manifest);
      }
      renderGraph(manifest);
      const hash = location.hash.replace('#',''); if(hash) openNote(hash);
    }catch(e){
      listEl.innerHTML = '<li style="color:tomato">Missing writeups/manifest.json</li>';
    }
  }

  function renderList(items){
    listEl.innerHTML = '';
    items.forEach(it=>{
      const li=document.createElement('li');
      const a=document.createElement('a');
      a.href='#'; a.textContent=it.title;
      a.onclick=(ev)=>{ev.preventDefault();openNote(it.slug)};
      const m=document.createElement('div');
      m.style.fontSize='12px'; m.style.color='#9aa6b2';
      m.textContent=(it.date?it.date+' · ':'')+(it.tags||[]).join(', ');
      li.appendChild(a); li.appendChild(m); listEl.appendChild(li);
    });
  }

  async function openNote(slug){
    viewer.innerHTML = '<div style="padding:24px;color:#9aa6b2">Loading…</div>';
    try{
      const r = await fetch(`/writeups/notes/${slug}.md`);
      if(!r.ok) throw new Error('note not found');
      const txt = await r.text();
      const body = txt.replace(/^---[\s\S]*?---\n/,''); // strip front-matter
      viewer.innerHTML = md.render(body);
      focusNode(slug);
      location.hash = slug;
    }catch(e){
      viewer.innerHTML = `<div style="padding:24px;color:tomato">Error: ${e.message}</div>`;
    }
  }

  search.addEventListener('input',()=>{
    const q=search.value.toLowerCase();
    const filtered = manifest.filter(m =>
      (m.title||'').toLowerCase().includes(q) ||
      (m.tags||[]).join(' ').toLowerCase().includes(q)
    );
    renderList(filtered);
  });

  function renderGraph(items){
    const nodes=items.map(i=>({ data:{ id:i.slug, label:i.title }}));
    const edges=[];
    items.forEach(i => (i.links||[]).forEach(l => edges.push({ data:{ id:i.slug+'->'+l, source:i.slug, target:l }})));

    cy = cytoscape({
      container: document.getElementById('graph'),
      elements:{ nodes, edges },
      style:[
        /* White nodes + label BELOW node with readable background/outline */
        { selector:'node', style:{
            'label':'data(label)',
            'font-size':10,
            'min-zoomed-font-size':6,        // hide labels when zoomed far out
            'text-wrap':'wrap',
            'text-max-width':160,
            'text-halign':'center',
            'text-valign':'bottom',          // label under the node
            'text-margin-y':12,
            'color':'#e6eef6',
            'text-outline-width':2,
            'text-outline-color':'#1a1a1e',
            'text-background-opacity':0.6,
            'text-background-color':'#1a1a1e',
            'text-background-shape':'roundrectangle',
            'text-background-padding':2,

            'background-color':'#ffffff',
            'border-color':'#ffffff',
            'border-width':0.5,
            'shadow-blur':8,
            'shadow-color':'rgba(255,255,255,0.25)',
            'shadow-opacity':0.8,
            'shadow-offset-x':0,
            'shadow-offset-y':0
        }},
        /* White edges */
        { selector:'edge', style:{
            'width':1,
            'line-color':'rgba(255,255,255,0.55)'
        }},
        /* Active/hover highlight */
        { selector:'.active', style:{
            'background-color':'#7fd1ff',
            'border-color':'#7fd1ff',
            'line-color':'#7fd1ff',
            'text-outline-color':'#0f1417',
            'text-background-color':'#0f1417'
        }},
        /* Dim non-neighborhood when focusing */
        { selector:'.faded', style:{
            'opacity':0.2,
            'text-opacity':0.2,
            'line-opacity':0.2
        }},
        /* Hover outline */
        { selector:'.hovered', style:{
            'border-width':2,
            'border-color':'#ffffff',
            'background-color':'#ffffff'
        }}
      ],
      layout:{ name:'cose', animate:true },
      wheelSensitivity: 0.2
    });

    // Interactions: click to open, hover effect
    cy.on('tap','node',ev=>openNote(ev.target.id()));
    cy.on('mouseover','node',ev=>ev.target.addClass('hovered'));
    cy.on('mouseout','node',ev=>ev.target.removeClass('hovered'));

    // Drag / pan / zoom
    cy.userPanningEnabled(true);
    cy.zoomingEnabled(true);
    cy.boxSelectionEnabled(false);
  }

  function focusNode(slug){
    if(!cy) return;
    cy.elements().removeClass('active faded');
    const node = cy.getElementById(slug);
    if(node && node.length){
      node.addClass('active');
      const hood = node.closedNeighborhood();
      cy.elements().difference(hood).addClass('faded');
      cy.center(node);
      cy.fit(node, 90);
    }
  }

  loadManifest();
  </script>
</body>
</html>
