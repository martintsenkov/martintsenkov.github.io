<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Writeups â€” Martin Tsenkov</title>

  <!-- Favicons (from /assets) -->
  <link rel="icon" href="/assets/favicon.ico?v=2" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32.png?v=2">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16.png?v=2">
  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png?v=2">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#1e1e22">

  <style>
  /* ===== Base layout (Obsidian-like) ===== */
  :root{
    --topbarH: 38px;
    --splitterH: 10px;
    --graphMin: 200px;
    --graphDefault: 38vh;
    --viewerRow: auto;
    --graphRow: var(--graphDefault);
  }

  body{
    font-family: Inter, Arial, sans-serif;
    background:#1e1e22; color:#dfe3e8;
    margin:0; display:flex; height:100vh;
  }

  /* Sidebar (left) */
  #sidebar{
    width:320px; background:#252529;
    border-right:1px solid #2d2d31; padding:12px; overflow:auto;
    box-shadow: inset -1px 0 0 rgba(255,255,255,.04), inset -3px 0 12px rgba(0,0,0,.4);
  }

  /* Main area uses grid: topbar / viewer / splitter / graph */
  #main{
    flex:1; display:grid; background:#1f1f23;
    grid-template-rows: var(--topbarH) var(--viewerRow) var(--splitterH) minmax(var(--graphMin), var(--graphRow));
  }

  /* Fake Obsidian topbar (only over main area) */
  #topbar{
    display:flex; align-items:center; justify-content:space-between;
    padding:0 10px; height:var(--topbarH);
    background:#2a2a2e; border-bottom:1px solid #2d2d31; color:#cfd3d8;
  }
  #topbar .title{ font-size:14px; letter-spacing:.15px; }
  .icon-btn{
    background:none; border:1px solid #3a3a40; color:#9aa6b2;
    padding:4px 8px; border-radius:8px; cursor:pointer; margin-left:6px;
  }
  .icon-btn:hover{ color:#7fd1ff; filter:brightness(1.08); }

  #viewer{
    padding:20px; overflow:auto; background:#1a1a1e;
    transition:opacity .2s ease;
  }
  #viewer.loading{ opacity:.4; }

  #splitter{
    position:relative; background:#2d2d31; cursor:row-resize;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.04), inset 0 -1px 0 rgba(0,0,0,.35);
  }
  #splitter:before{
    content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:56px; height:4px; border-radius:999px; background:#3a3a3f;
  }

  #graph{ position:relative; border-top:1px solid #2d2d31; }

  /* Graph action buttons */
  .graph-actions{ position:absolute; right:10px; top:8px; z-index:10; display:flex; gap:6px }
  .gbtn{
    background:#2a2a2e; border:1px solid #3a3a40; color:#cfd3d8;
    font-size:12px; padding:6px 10px; border-radius:8px; cursor:pointer;
  }
  .gbtn:hover{ filter:brightness(1.08); }
  .gbtn.active{ border-color:#7fd1ff; color:#7fd1ff; }

  a{ color:#89c9ff; text-decoration:none }
  a:hover{ color:#b8e3ff }

  /* Sidebar list */
  ul{ list-style:none; padding:0; margin:0 }
  li{ padding:6px 0; border-bottom:1px dashed #2a2a2e }
  header{ padding:12px; border-bottom:1px solid #2d2d31; background:#2a2a2e }
  .meta{ font-size:13px; color:#9aa6b2 }

  /* Mobile tweaks */
  @media (max-width:720px){
    body{ flex-direction:column }
    #sidebar{ width:auto; border-right:none; border-bottom:1px solid #2d2d31 }
    :root{ --graphDefault:42vh }
  }
  </style>
</head>
<body>
  <aside id="sidebar">
    <header>
      <strong>CTF &amp; Lab Writeups</strong>
      <div class="meta">Martin's offensive security writeups(developing yet)</div>
    </header>
    <ul id="list"></ul>
  </aside>

  <section id="main">
    <!-- Obsidian-like top bar -->
    <div id="topbar">
      <span class="title">ðŸ“˜ CTF &amp; Lab Notes</span>
      <div>
        <button class="icon-btn" id="btnLocalToggle" title="Toggle Local/Global graph">Local graph</button>
      </div>
    </div>

    <div id="viewer"><div style="padding:24px;color:#9aa6b2">Select a writeup from the list on the left.</div></div>

    <div id="splitter" title="Drag to resize. Double-click to maximize/minimize graph."></div>

    <div id="graph">
      <div class="graph-actions">
        <button class="gbtn" id="toggleGraph">Toggle full graph</button>
        <button class="gbtn" id="btnLocal" title="Show only neighborhood of selected note">Local</button>
      </div>
    </div>
  </section>

  <script src="https://unpkg.com/markdown-it/dist/markdown-it.min.js"></script>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>

  <script>
  const md = window.markdownit();
  const manifestUrl = './manifest.json';
  const listEl = document.getElementById('list');
  const viewer  = document.getElementById('viewer');
  const rootStyle = document.documentElement.style;
  const btnLocal = document.getElementById('btnLocal');

  let manifest = [], cy, graphMax = false, localMode = false, lastSlug = null;
  let activeCategoryId = null; // null => show only categories

  async function loadManifest(){
    try{
      const r = await fetch(manifestUrl);
      if(!r.ok) throw new Error('manifest not found');
      manifest = await r.json();

      if(!Array.isArray(manifest) || manifest.length === 0){
        listEl.innerHTML = '<li style="color:#9aa6b2">No notes yet. Add entries to <code>writeups/manifest.json</code>.</li>';
      } else {
        renderList(manifest);
      }

      renderGraph(manifest);

      const hash = location.hash.replace('#','');
      if(hash) openNote(hash);
    }catch(e){
      listEl.innerHTML = '<li style="color:tomato">Missing writeups/manifest.json</li>';
    }
  }

  function renderList(items){
    listEl.innerHTML = '';
    items.forEach(it=>{
      const li=document.createElement('li');
      const a=document.createElement('a');
      a.href='#'; a.textContent=it.title;
      a.onclick=(ev)=>{ev.preventDefault();openNote(it.slug)};

      const m=document.createElement('div');
      m.style.fontSize='12px'; m.style.color='#9aa6b2';
      m.textContent=(it.date?it.date+' Â· ':'')+(it.tags||[]).join(', ');

      li.appendChild(a);
      li.appendChild(m);
      listEl.appendChild(li);
    });
  }

  function slugifyCategory(name){
    return 'cat:' + String(name || 'Unsorted')
      .trim()
      .toLowerCase()
      .replace(/[^a-z0-9]+/g,'-')
      .replace(/(^-|-$)/g,'');
  }

  function getCategoryNameForItem(it){
    return (it && it.category && String(it.category).trim()) ? String(it.category).trim() : 'Unsorted';
  }

  function findItemBySlug(slug){
    return (manifest || []).find(x => x.slug === slug) || null;
  }

  async function openNote(slug){
    viewer.classList.add('loading');
    viewer.innerHTML = '<div style="padding:24px;color:#9aa6b2">Loadingâ€¦</div>';

    try{
      const item = findItemBySlug(slug);
      if(item){
        const catId = slugifyCategory(getCategoryNameForItem(item));
        // Ensure the note is visible in graph (switch to its category)
        if(activeCategoryId !== catId) showCategory(catId);
      }

      const r = await fetch(`/writeups/notes/${slug}.md`);
      if(!r.ok) throw new Error('note not found');

      const txt = await r.text();
      const body = txt.replace(/^---[\s\S]*?---\n/,''); // strip front-matter
      viewer.innerHTML = md.render(body);

      lastSlug = slug;
      location.hash = slug;

      focusNode(slug);
      if(localMode) applyLocalFilter(slug);

    }catch(e){
      viewer.innerHTML = `<div style="padding:24px;color:tomato">Error: ${e.message}</div>`;
    }finally{
      setTimeout(()=>viewer.classList.remove('loading'), 120);
    }
  }

  function renderGraph(items){
    // Categories
    const catNameSet = new Set(items.map(getCategoryNameForItem));
    const catNames = Array.from(catNameSet).sort((a,b)=>a.localeCompare(b));

    // Nodes
    const categoryNodes = catNames.map(name => ({
      data:{ id: slugifyCategory(name), label: name, type: 'category' }
    }));

    const noteNodes = items.map(i => ({
      data:{
        id: i.slug,
        label: i.title,
        type: 'note',
        categoryId: slugifyCategory(getCategoryNameForItem(i))
      }
    }));

    // Edges
    const catEdges = items.map(i => ({
      data:{
        id: `${slugifyCategory(getCategoryNameForItem(i))}=>${i.slug}`,
        source: slugifyCategory(getCategoryNameForItem(i)),
        target: i.slug,
        type: 'cat'
      }
    }));

    const linkEdges = [];
    items.forEach(i => (i.links||[]).forEach(l => {
      linkEdges.push({
        data:{ id: i.slug+'->'+l, source: i.slug, target: l, type: 'note' }
      });
    }));

    const nodes = [...categoryNodes, ...noteNodes];
    const edges = [...catEdges, ...linkEdges];

    cy = cytoscape({
      container: document.getElementById('graph'),
      elements:{ nodes, edges },
      style:[
        { selector:'node', style:{
          'label':'data(label)', 'font-size':10, 'min-zoomed-font-size':6,
          'text-wrap':'wrap', 'text-max-width':160,
          'text-halign':'center', 'text-valign':'bottom', 'text-margin-y':12,
          'color':'#e6eef6', 'text-outline-width':2, 'text-outline-color':'#1a1a1e',
          'text-background-opacity':0.6, 'text-background-color':'#1a1a1e',
          'text-background-shape':'roundrectangle', 'text-background-padding':2,
          'background-color':'#ffffff', 'border-color':'#ffffff', 'border-width':0.5,
          'shadow-blur':8, 'shadow-color':'rgba(255,255,255,0.25)',
          'shadow-opacity':0.8, 'shadow-offset-x':0, 'shadow-offset-y':0
        }},
        { selector:'node[type="category"]', style:{
          'width': 30, 'height': 30,
          'background-color':'#7fd1ff',
          'border-color':'#7fd1ff',
          'border-width': 1,
          'text-margin-y':14,
          'font-size':11,
          'text-outline-color':'#0f1417',
          'text-background-color':'#0f1417'
        }},
        { selector:'node[type="note"]', style:{ 'width': 18, 'height': 18 }},
        { selector:'edge', style:{ 'width':1, 'line-color':'rgba(255,255,255,0.55)' }},
        { selector:'edge[type="cat"]', style:{ 'line-color':'rgba(127,209,255,0.45)' }},
        { selector:'.active', style:{
          'background-color':'#7fd1ff','border-color':'#7fd1ff','line-color':'#7fd1ff',
          'text-outline-color':'#0f1417','text-background-color':'#0f1417'
        }},
        { selector:'.faded', style:{ 'opacity':0.15, 'text-opacity':0.15, 'line-opacity':0.15 }},
        { selector:'.hovered', style:{ 'border-width':2, 'border-color':'#ffffff', 'background-color':'#ffffff' }}
      ],
      layout:{ name:'cose', animate:true },
      wheelSensitivity: 0.2
    });

    // Interactions
    cy.on('tap','node',ev=>{
      const n = ev.target;
      const t = n.data('type');
      if(t === 'category'){
        toggleCategory(n.id());
      } else {
        openNote(n.id());
      }
    });

    cy.on('mouseover','node',ev=>ev.target.addClass('hovered'));
    cy.on('mouseout','node',ev=>ev.target.removeClass('hovered'));

    cy.userPanningEnabled(true);
    cy.zoomingEnabled(true);
    cy.boxSelectionEnabled(false);

    // Default: show only categories
    showCategoriesOnly();
  }

  function showCategoriesOnly(){
    if(!cy) return;

    // local mode doesn't make sense here
    setLocalMode(false);

    activeCategoryId = null;
    cy.elements().removeClass('active faded');

    cy.nodes('[type="note"]').style('display','none');
    cy.edges().style('display','none');
    cy.nodes('[type="category"]').style('display','element');

    cy.layout({ name:'cose', animate:true }).run();
    cy.fit(cy.nodes('[type="category"]'), 80);
  }

  function showCategory(catId){
    if(!cy) return;

    // local mode is per-note; disable when switching category view
    setLocalMode(false);

    activeCategoryId = catId;

    const notes = cy.nodes(`[type="note"][categoryId="${catId}"]`);
    const catNode = cy.getElementById(catId);

    // Hide all first
    cy.nodes('[type="category"]').style('display','none');
    cy.nodes('[type="note"]').style('display','none');
    cy.edges().style('display','none');

    // Show only this category + its notes
    catNode.style('display','element');
    notes.style('display','element');

    // Show edges: category->notes
    cy.edges(`[type="cat"][source="${catId}"]`).style('display','element');

    // Show note-to-note edges only if both endpoints are visible notes
    cy.edges('[type="note"]').forEach(e=>{
      const s = e.source();
      const t = e.target();
      if(notes.contains(s) && notes.contains(t)){
        e.style('display','element');
      }
    });

    // Highlight category
    cy.elements().removeClass('active faded');
    catNode.addClass('active');

    const visibleSet = notes.union(catNode);
    cy.layout({ name:'cose', animate:true }).run();
    cy.center(catNode);
    cy.fit(visibleSet, 110);
  }

  function toggleCategory(catId){
    if(activeCategoryId === catId) showCategoriesOnly();
    else showCategory(catId);
  }

  function focusNode(slug){
    if(!cy) return;

    cy.elements().removeClass('active');
    const node = cy.getElementById(slug);
    if(node && node.length){
      node.addClass('active');
      cy.center(node);
      cy.fit(node, 120);
    }
  }

  /* ---- Local / Global graph filter (notes only) ---- */
  function setLocalMode(on){
    // local mode only works when a note is selected inside a category view
    localMode = on;
    btnLocal.classList.toggle('active', localMode);

    if(!cy) return;

    if(localMode && lastSlug){
      applyLocalFilter(lastSlug);
    } else {
      // restore category view
      if(activeCategoryId) showCategory(activeCategoryId);
      else showCategoriesOnly();
      // keep highlight
      if(lastSlug) focusNode(lastSlug);
    }
  }

  function applyLocalFilter(slug){
    if(!cy) return;
    if(!activeCategoryId) return; // no local filter on categories-only view

    const n = cy.getElementById(slug);
    if(!n || !n.length) return;

    const hood = n.closedNeighborhood().union(n);
    // Only within current visible category view:
    // hide all visible elements, show only hood
    cy.elements().style('display','none');
    hood.style('display','element');
    cy.center(n);
    cy.fit(hood, 120);
  }

  btnLocal.addEventListener('click', ()=> setLocalMode(!localMode));
  document.getElementById('btnLocalToggle').addEventListener('click', ()=> setLocalMode(!localMode));

  /* --- Resizable splitter / Fullscreen toggle --- */
  (function(){
    const splitter = document.getElementById('splitter');
    const btn = document.getElementById('toggleGraph');
    let dragging=false, startY=0, startViewerH=0, startGraphH=0;

    const setRows = (viewerPx, graphPx)=>{
      rootStyle.setProperty('--viewerRow', viewerPx+'px');
      rootStyle.setProperty('--graphRow', graphPx+'px');
      if(cy) cy.resize();
    };

    splitter.addEventListener('pointerdown', (e)=>{
      dragging=true; splitter.setPointerCapture(e.pointerId);
      startY = e.clientY;
      startViewerH = document.getElementById('viewer').getBoundingClientRect().height;
      startGraphH = document.getElementById('graph').getBoundingClientRect().height;
      e.preventDefault();
    });

    window.addEventListener('pointermove', (e)=>{
      if(!dragging) return;
      const dy = e.clientY - startY;
      let newViewer = Math.max(0, startViewerH + dy);
      let newGraph  = Math.max(parseInt(getComputedStyle(document.documentElement).getPropertyValue('--graphMin'))||200, startGraphH - dy);
      setRows(newViewer, newGraph);
    });

    window.addEventListener('pointerup', ()=>{ dragging=false; });

    splitter.addEventListener('dblclick', toggleGraph);
    btn.addEventListener('click', toggleGraph);

    function toggleGraph(){
      graphMax = !graphMax;
      if(graphMax){
        rootStyle.setProperty('--viewerRow','0px');
        rootStyle.setProperty('--graphRow','1fr');
      }else{
        rootStyle.setProperty('--viewerRow','auto');
        rootStyle.setProperty('--graphRow', getComputedStyle(document.documentElement).getPropertyValue('--graphDefault') || '38vh');
      }
      if(cy) cy.resize();
    }
  })();

  loadManifest();
  </script>
</body>
</html>
